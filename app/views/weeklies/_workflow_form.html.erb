<%= simple_form_for [@current_weekly,@workflow] do |f| %>

    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="newWorkflowLabel">新工作流</h4>
      </div>
      <div class="modal-body">
        
          <div class="form-group">

            <%= f.input :workflow_type_id,class: 'workflowtype_selection',label: '工作类别',  collection: {
                   "售前(客户交流)" => 1,
                  "售前(招标书编写)" => 2,
                  "售前(投标书编写)" => 3,
                  "售前(解决方案编写)" => 4,
                  "售前(投标或讲标)" => 5,
                  "售前(厂商交流)" => 14,
                    "售前(临时)" => 13,
                         "售中" => 6,
                         "售后" => 7,
                         "供货" => 8,
                       "单次服务" => 9,
                         "集成" => 10,
                       "认证考试" => 11,
                       "技术提升" => 12,
                       "部门工作" => 15,
              } %>




            <%= f.input :project_id,label: false,as: :hidden%>
            <%#= f.input :project_id,label: '项目名', collection: @project_names %>

            



            <div class="form-group hidden" id="project_number">
              <label for="search_project_blank">* 项目号</label>
              <div id="project_info"></div>
              <input type="text" class="form-control" id="search_project_blank" placeholder="">
              
            </div>


            <%= f.input :project_sales,label: '* 销售'%>

            <%= f.input :description,label: '工作内容描述', input_html: { class: "form-control"} %>

            <%#= f.input :worktype,label: '工作类别', collection:['售前','售中','售后','供货','单次服务','集成'] %>


      

            <!-- 多选框 -->

            <label>涉及厂商</label>

            <%= f.association :companies,label: false, as: :check_boxes ,item_wrapper_class: 'inline'  %>

            <%= f.input :other_company,label: false,placeholder: '其他厂商'  %>
            <label>技术方向</label>
            <%= f.association :skills,label: false, as: :check_boxes ,item_wrapper_class: 'inline'  %>

            <%= f.input :other_skill,label: false,placeholder: '其他方向'  %>

            <%= f.input :remaining_issue,label: '遗留问题', input_html: { class: "form-control"} %>


            <%= f.input :hours,label: '工作量(小时)', input_html: { class: "form-control"} %>

            <label for="">开始日期</label>

            <%= f.datetime_select :start_time,:discard_hour => true ,default: @current_weekly.start_time %>

            <br>
            
            <label for="">结束日期</label>

            <%= f.datetime_select :end_time,:discard_hour => true ,default: @current_weekly.end_time %>



          </div>
          
        
                
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <%= f.submit "提交", class: "btn btn-primary", data: { disable_with: "提交ing..." } %>
      </div>
    </div>


<% end %>


<style>
  span.checkbox.inline {
    display: inline;
    padding: 1em;
  }
</style>


<script>

$(document).ready(function(){
  $("#search_project_blank").focus(function(){
    $('#search_project_blank').css("background-color","#fff");
  });
  $("#search_project_blank").blur(function(){
    code = $('#search_project_blank').val();
    searchProject(code);
  });

  $('.workflow_project_sales').addClass('hidden');
  $('#project_number').addClass('hidden');
  // 如果选项卡选中了什么
  $('#workflow_workflow_type_id').change(function() {
    // console.log('haha')
    /* Act on the event */
    console.log($(this).val());
    if ($(this).val()>=10 && $(this).val()<=14 ) {
      // 隐藏项目号
      $('#project_number').addClass('hidden')
      // 显示销售
      $('.workflow_project_sales').removeClass('hidden');
    }else if ($(this).val()>=15) {
      // 隐藏项目号
      $('#project_number').addClass('hidden')
      // 显示销售
      $('.workflow_project_sales').addClass('hidden');
    }else{
      // 删除项目号
      $('#project_number').removeClass('hidden')
      // 隐藏销售
      $('.workflow_project_sales').addClass('hidden');
    }
  });


});


function searchProject(code) {
  $.ajax({
    url: '/api/v1/projects/'+code,
    type: 'GET',
    dataType: 'json',
    // 加入动画
    beforeSend: function() {
      $("#loader").remove();
      $("#project_info").append('<div id="loader" class="loader"><span class="loader-inner">Loading...</span></div>');
    },

    complete: function() {
      $("#loader").remove();
      // 如果能成功加载信息再显示新浪
      // 从新浪获取价格
      // 如果第一位是6,则为沪市
    },
    success: function (data_obj) {
      if (data_obj['stat']==1) {
        console.log(data_obj['data']);
        $('#workflow_project_id').val(data_obj['data']['id'])
        $('#project_info').html('<p>'+data_obj['data']['code']+'#'+data_obj['data']['name']+'#'+data_obj['data']['project_type']+'#'+data_obj['data']['sbu']+'#'+data_obj['data']['sales_name']+'</p>')
      }else if((data_obj['stat']==2)){
        $('#workflow_project_id').val(data_obj['data']['id'])
        $('#search_project_blank').css("background-color","#CC3333");
        $('#project_info').html('<p class="text-danger"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true">'+data_obj['data']['code']+'#'+data_obj['data']['name']+'#'+data_obj['data']['project_type']+'#'+data_obj['data']['sbu']+'#'+data_obj['data']['sales_name']+'(该项目已禁止继续派工)</p>')
      }else{
        console.log('项目号不存在');
        $('#workflow_project_id').val('');
        $('#search_project_blank').css("background-color","#CC3333");

        $('#project_info').html('<p class="text-danger"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true">项目号不存在</span></p>')
      }
    },
    error: function() {
      /* Act on the event */
      console.log("error");
    }
  });


}
 



</script>

